C51 COMPILER V9.60.7.0   TIMER2                                                            01/26/2026 10:01:40 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE TIMER2
OBJECT MODULE PLACED IN .\Release\Objects\timer2.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE ..\..\User\timer2.c LARGE OPTIMIZE(9,SIZE) BROWSE INTVECTOR(0X000C) INCD
                    -IR(..\..\Libraries\Include;..\..\User) INTERVAL(3) DEBUG OBJECTEXTEND PRINT(.\Release\Listings\timer2.lst) OBJECT(.\Rele
                    -ase\Objects\timer2.obj)

line level    source

   1          #include "timer2.h"
   2          #define TIMER2_PEROID_VAL (SYSCLK / 128 / 10000 - 1) // å‘¨æœŸå€¼=ç³»ç»Ÿæ—¶é’Ÿ/åˆ†é¢‘/é¢‘çŽ‡ - 1
   3          
   4          extern volatile bit flag_is_in_power_on; // æ˜¯å¦å¤„äºŽå¼€æœºç¼“å¯åŠ¨
   5          
   6          static volatile u16 pwm_duty_add_cnt; // ç”¨äºŽæŽ§åˆ¶pwmå¢žåŠ çš„æ—¶é—´è®¡æ•°
   7          static volatile u16 pwm_duty_sub_cnt; // ç”¨äºŽæŽ§åˆ¶pwmé€’å‡çš„æ—¶é—´è®¡æ•°
   8          
   9          volatile bit flag_is_pwm_add_time_comes = 0; // æ ‡å¿—ä½ï¼Œpwmå ç©ºæ¯”é€’å¢žæ—¶é—´åˆ°æ¥
  10          volatile bit flag_is_pwm_sub_time_comes = 0; // æ ‡å¿—ä½ï¼Œpwmå ç©ºæ¯”é€’å‡æ—¶é—´åˆ°æ¥
  11          
  12          static volatile u16 pwm_duty_change_cnt = 0; // ç”¨äºŽæŽ§åˆ¶pwmå˜åŒ–çš„æ—¶é—´è®¡æ•°ï¼ˆç”¨åœ¨æ—‹é’®è°ƒèŠ‚ç
             -š„PWMå ç©ºæ¯”ä¸­ï¼‰
  13          
  14          void timer2_config(void)
  15          {
  16   1          __EnableIRQ(TMR2_IRQn); // ä½¿èƒ½timer2ä¸­æ–­
  17   1          IE_EA = 1;              // ä½¿èƒ½æ€»ä¸­æ–­
  18   1      
  19   1          // è®¾ç½®timer2çš„è®¡æ•°åŠŸèƒ½ï¼Œé…ç½®ä¸€ä¸ªé¢‘çŽ‡ä¸º 10 kHzçš„ä¸­æ–­
  20   1          TMR_ALLCON = TMR2_CNT_CLR(0x1);                               // æ¸…é™¤è®¡æ•°å€¼
  21   1          TMR2_PRH = TMR_PERIOD_VAL_H((TIMER2_PEROID_VAL >> 8) & 0xFF); // å‘¨æœŸå€¼
  22   1          TMR2_PRL = TMR_PERIOD_VAL_L((TIMER2_PEROID_VAL >> 0) & 0xFF);
  23   1          TMR2_CONH = TMR_PRD_PND(0x1) | TMR_PRD_IRQ_EN(0x1);                          // è®¡æ•°ç­‰äºŽå‘¨æœŸæ—¶å
             -…è®¸å‘ç”Ÿä¸­æ–­
  24   1          TMR2_CONL = TMR_SOURCE_SEL(0x7) | TMR_PRESCALE_SEL(0x7) | TMR_MODE_SEL(0x1); // é€‰æ‹©ç³»ç»Ÿæ—¶é’Ÿï¼Œ1
             -28åˆ†é¢‘ï¼Œè®¡æ•°æ¨¡å¼
  25   1      }
  26          
  27          // å®šæ—¶å™¨ ä¸­æ–­æœåŠ¡å‡½æ•°
  28          void TIMR2_IRQHandler(void) interrupt TMR2_IRQn
  29          {
  30   1          // è¿›å…¥ä¸­æ–­è®¾ç½®IPï¼Œä¸å¯åˆ é™¤
  31   1          __IRQnIPnPush(TMR2_IRQn);
  32   1      
  33   1          // ---------------- ç”¨æˆ·å‡½æ•°å¤„ç† -------------------
  34   1      
  35   1          // å‘¨æœŸä¸­æ–­
  36   1          if (TMR2_CONH & TMR_PRD_PND(0x1)) // çº¦100usè§¦å‘ä¸€æ¬¡ä¸­æ–­
  37   1          {
  38   2              TMR2_CONH |= TMR_PRD_PND(0x1); // æ¸…é™¤pending
  39   2      
  40   2              // tmr2_cnt++;
  41   2              // P13 = ~P13; // æµ‹è¯•ä¸­æ–­è§¦å‘å‘¨æœŸ
  42   2      
  43   2              pwm_duty_add_cnt++;
  44   2              pwm_duty_sub_cnt++;
  45   2              pwm_duty_change_cnt++;
  46   2      
  47   2              if (pwm_duty_sub_cnt >= 13) // 1300usï¼Œ1.3ms
  48   2              // if (pwm_duty_sub_cnt >= 50)
  49   2              {
  50   3                  pwm_duty_sub_cnt = 0;
C51 COMPILER V9.60.7.0   TIMER2                                                            01/26/2026 10:01:40 PAGE 2   

  51   3                  flag_is_pwm_sub_time_comes = 1;
  52   3              }
  53   2      
  54   2              // if (pwm_duty_add_cnt >= 133) // 13300us, 13.3ms
  55   2              if (pwm_duty_add_cnt >= 13) //
  56   2              {
  57   3                  pwm_duty_add_cnt = 0;
  58   3                  flag_is_pwm_add_time_comes = 1;
  59   3              }
  60   2      
  61   2      #if 1 // rfä¿¡å·æŽ¥æ”¶ ï¼ˆ100usè°ƒç”¨ä¸€æ¬¡ï¼‰
  62   2              {
  63   3                  static volatile u8 rf_bit_cnt;            // RFä¿¡å·æŽ¥æ”¶çš„æ•°æ®ä½è®¡æ•°å€¼
  64   3                  static volatile u32 __rf_data;            // å®šæ—¶å™¨ä¸­æ–­ä½¿ç”¨çš„æŽ¥æ”¶ç¼“å†²åŒºï¼Œé¿å…ç
             -›´æŽ¥è¦†ç›–å…¨å±€çš„æ•°æ®æŽ¥æ”¶ç¼“å†²åŒº
  65   3                  static volatile u8 flag_is_enable_recv;   // æ˜¯å¦ä½¿èƒ½æŽ¥æ”¶çš„æ ‡å¿—ä½ï¼Œè¦æŽ¥æ”¶åˆ° 5ms
             -+ çš„ä½Žç”µå¹³æ‰å¼€å§‹æŽ¥æ”¶
  66   3                  static volatile u8 __flag_is_recved_data; // è¡¨ç¤ºä¸­æ–­æœåŠ¡å‡½æ•°æŽ¥æ”¶åˆ°äº†rfæ•°æ®
  67   3      
  68   3                  static volatile u8 low_level_cnt;  // RFä¿¡å·ä½Žç”µå¹³è®¡æ•°å€¼
  69   3                  static volatile u8 high_level_cnt; // RFä¿¡å·é«˜ç”µå¹³è®¡æ•°å€¼
  70   3      
  71   3                  // åœ¨å®šæ—¶å™¨ ä¸­æ‰«æç«¯å£ç”µå¹³
  72   3                  if (0 == RFIN_PIN)
  73   3                  {
  74   4                      // å¦‚æžœRFæŽ¥æ”¶å¼•è„šä¸ºä½Žç”µå¹³ï¼Œè®°å½•ä½Žç”µå¹³çš„æŒç»­æ—¶é—´
  75   4                      low_level_cnt++;
  76   4      
  77   4                      /*
  78   4                          ä¸‹é¢çš„åˆ¤æ–­æ¡ä»¶æ˜¯é¿å…éƒ¨åˆ†é¥æŽ§å™¨æˆ–æŽ¥æ”¶æ¨¡å—åªå‘é€24ä½æ•°æ®ï¼Œæœ€
             -åŽä¸æ‹‰é«˜ç”µå¹³çš„æƒ…å†µ
  79   4                      */
  80   4                      if (low_level_cnt >= 30 && rf_bit_cnt == 23) // å¦‚æžœä½Žç”µå¹³å¤§äºŽ3000usï¼Œå¹¶ä¸”å·²ç»
             -æŽ¥æ”¶äº†23ä½æ•°æ®
  81   4                      {
  82   5                          if (high_level_cnt >= 6 && high_level_cnt < 20)
  83   5                          {
  84   6                              __rf_data |= 0x01;
  85   6                          }
  86   5                          else if (high_level_cnt >= 1 && high_level_cnt < 6)
  87   5                          {
  88   6                          }
  89   5      
  90   5                          __flag_is_recved_data = 1; // æŽ¥æ”¶å®Œæˆæ ‡å¿—ä½ç½®ä¸€
  91   5                          flag_is_enable_recv = 0;
  92   5                      }
  93   4                  }
  94   3                  else
  95   3                  {
  96   4                      if (low_level_cnt > 0)
  97   4                      {
  98   5                          // å¦‚æžœä¹‹å‰æŽ¥æ”¶åˆ°äº†ä½Žç”µå¹³ä¿¡å·ï¼ŒçŽ°åœ¨é‡åˆ°äº†é«˜ç”µå¹³ï¼Œåˆ¤æ–­æ˜¯å¦æŽ
             -¥æ”¶å®Œæˆäº†ä¸€ä½æ•°æ®
  99   5                          if (low_level_cnt > 50)
 100   5                          {
 101   6                              // å¦‚æžœä½Žç”µå¹³æŒç»­æ—¶é—´å¤§äºŽ50 * 100usï¼ˆ5msï¼‰ï¼Œå‡†å¤‡ä¸‹ä¸€æ¬¡å†è¯»å–
             -æœ‰æ•ˆä¿¡å·
 102   6                              __rf_data = 0;  // æ¸…é™¤æŽ¥æ”¶çš„æ•°æ®å¸§
 103   6                              rf_bit_cnt = 0; // æ¸…é™¤ç”¨æ¥è®°å½•æŽ¥æ”¶çš„æ•°æ®ä½æ•°
 104   6      
 105   6                              flag_is_enable_recv = 1;
 106   6                          }
C51 COMPILER V9.60.7.0   TIMER2                                                            01/26/2026 10:01:40 PAGE 3   

 107   5                          else if (flag_is_enable_recv &&
 108   5                                   low_level_cnt >= 2 && low_level_cnt < 7 &&
 109   5                                   high_level_cnt >= 6 && high_level_cnt < 20)
 110   5                          {
 111   6                              // å¦‚æžœä½Žç”µå¹³æŒç»­æ—¶é—´åœ¨360uså·¦å³ï¼Œé«˜ç”µå¹³æŒç»­æ—¶é—´åœ¨760uså·¦å³
             -ï¼Œè¯´æ˜ŽæŽ¥æ”¶åˆ°äº†1
 112   6                              __rf_data |= 0x01;
 113   6                              rf_bit_cnt++;
 114   6                              if (rf_bit_cnt != 24)
 115   6                              {
 116   7                                  __rf_data <<= 1; // ç”¨äºŽå­˜æ”¾æŽ¥æ”¶24ä½æ•°æ®çš„å˜é‡å·¦ç§»ä¸€ä½
 117   7                              }
 118   6                          }
 119   5                          else if (flag_is_enable_recv &&
 120   5                                   low_level_cnt >= 7 && low_level_cnt < 20 &&
 121   5                                   high_level_cnt >= 1 && high_level_cnt < 6)
 122   5                          {
 123   6                              // å¦‚æžœä½Žç”µå¹³æŒç»­æ—¶é—´åœ¨840uså·¦å³ï¼Œé«˜ç”µå¹³æŒç»­æ—¶é—´åœ¨360uså·¦å³
             -ï¼Œè¯´æ˜ŽæŽ¥æ”¶åˆ°äº†0
 124   6                              __rf_data &= ~1;
 125   6                              rf_bit_cnt++;
 126   6                              if (rf_bit_cnt != 24)
 127   6                              {
 128   7                                  __rf_data <<= 1; // ç”¨äºŽå­˜æ”¾æŽ¥æ”¶24ä½æ•°æ®çš„å˜é‡å·¦ç§»ä¸€ä½
 129   7                              }
 130   6                          }
 131   5                          else
 132   5                          {
 133   6                              // å¦‚æžœä½Žç”µå¹³æŒç»­æ—¶é—´ä¸ç¬¦åˆ0å’Œ1çš„åˆ¤æ–­æ¡ä»¶ï¼Œè¯´æ˜Žæ­¤æ—¶æ²¡æœ‰æŽ
             -¥æ”¶åˆ°ä¿¡å·
 134   6                              __rf_data = 0;
 135   6                              rf_bit_cnt = 0;
 136   6                              flag_is_enable_recv = 0;
 137   6                          }
 138   5      
 139   5                          low_level_cnt = 0; // æ— è®ºæ˜¯å¦æŽ¥æ”¶åˆ°ä¸€ä½æ•°æ®ï¼Œé‡åˆ°é«˜ç”µå¹³æ—¶ï¼Œå…ˆæ¸…é
             -™¤ä¹‹å‰çš„è®¡æ•°å€¼
 140   5                          high_level_cnt = 0;
 141   5      
 142   5                          if (24 == rf_bit_cnt)
 143   5                          {
 144   6                              // å¦‚æžœæŽ¥æ”¶æˆäº†24ä½çš„æ•°æ®
 145   6                              __flag_is_recved_data = 1; // æŽ¥æ”¶å®Œæˆæ ‡å¿—ä½ç½®ä¸€
 146   6                              flag_is_enable_recv = 0;
 147   6                          }
 148   5                      }
 149   4                      else
 150   4                      {
 151   5                          // å¦‚æžœæŽ¥æ”¶åˆ°é«˜ç”µå¹³åŽï¼Œä½Žç”µå¹³çš„è®¡æ•°ä¸º0
 152   5      
 153   5                          if (0 == flag_is_enable_recv)
 154   5                          {
 155   6                              __rf_data = 0;
 156   6                              rf_bit_cnt = 0;
 157   6                              flag_is_enable_recv = 0;
 158   6                          }
 159   5                      }
 160   4      
 161   4                      // å¦‚æžœRFæŽ¥æ”¶å¼•è„šä¸ºé«˜ç”µå¹³ï¼Œè®°å½•é«˜ç”µå¹³çš„æŒç»­æ—¶é—´
 162   4                      high_level_cnt++;
 163   4                  }
 164   3      
C51 COMPILER V9.60.7.0   TIMER2                                                            01/26/2026 10:01:40 PAGE 4   

 165   3                  if (__flag_is_recved_data) //
 166   3                  {
 167   4                      rf_bit_cnt = 0;
 168   4                      __flag_is_recved_data = 0;
 169   4                      low_level_cnt = 0;
 170   4                      high_level_cnt = 0;
 171   4      
 172   4                      // if (rf_data != 0)
 173   4                      // if (0 == flag_is_recved_rf_data) /* å¦‚æžœä¹‹å‰æœªæŽ¥æ”¶åˆ°æ•°æ® æˆ–æ˜¯ å·²ç»å¤„ç†å
             -®Œä¸Šä¸€æ¬¡æŽ¥æ”¶åˆ°çš„æ•°æ® */
 174   4                      {
 175   5                          // çŽ°åœ¨æ”¹ä¸ºåªè¦æ”¶åˆ°æ–°çš„æ•°æ®ï¼Œå°±è¦†ç›–rf_data
 176   5                          rf_data = __rf_data;
 177   5                          flag_is_recved_rf_data = 1;
 178   5                      }
 179   4                      // else
 180   4                      // {
 181   4                      //     __rf_data = 0;
 182   4                      // }
 183   4                  }
 184   3              }
 185   2      #endif // rfä¿¡å·æŽ¥æ”¶ ï¼ˆ100usè°ƒç”¨ä¸€æ¬¡ï¼‰
 186   2      
 187   2      #if 1 // è°ƒèŠ‚PWMå ç©ºæ¯”
 188   2            // if (pwm_duty_change_cnt >= 10) // 1000us,1ms
 189   2              // if (pwm_duty_change_cnt >= 1) // 100usï¼ˆç”¨é¥æŽ§å™¨è°ƒèŠ‚ï¼Œåœ¨50%ä»¥ä¸Šè°ƒèŠ‚pwmå ç©ºæ¯”çš„
             -æ—¶å€™ï¼Œç¯å…‰ä¼šæœ‰æŠ–åŠ¨ï¼‰
 190   2              // if (pwm_duty_change_cnt >= 5) // 500us
 191   2              // if (pwm_duty_change_cnt >= 10) // x * 100us ï¼ˆç”¨é¥æŽ§å™¨è°ƒèŠ‚åˆ°50%ä»¥ä¸‹pwmå ç©ºæ¯”çš„æ—¶
             -å€™ï¼Œç¯å…‰ä¼šæœ‰æŠ–åŠ¨ï¼‰
 192   2              if (pwm_duty_change_cnt >= 20) // x * 100us ï¼ˆ ç”¨é¥æŽ§å™¨è°ƒèŠ‚æ—¶ï¼Œç¯å…‰ä¸ä¼šæœ‰æŠ–åŠ¨ï¼Œæ 
             -·æœºæœ€é«˜åŠŸçŽ‡ä¸º870W--åŠ ä¸Šé£Žæ‰‡ï¼‰
 193   2              // if (pwm_duty_change_cnt >= 30) // x * 100us ï¼ˆç”¨é¥æŽ§å™¨è°ƒèŠ‚æ—¶ï¼Œç¯å…‰ä¸ä¼šæœ‰æŠ–åŠ¨ï¼Œ
             -ä½†æ˜¯è°ƒèŠ‚æ—¶é—´è¿‡é•¿ï¼Œæ„Ÿè§‰ä¸è·Ÿæ‰‹ï¼‰
 194   2              {
 195   3      
 196   3                  pwm_duty_change_cnt = 0;
 197   3      
 198   3                  if (0 == flag_is_in_power_on) // ä¸å¤„äºŽå¼€æœºç¼“å¯åŠ¨ï¼Œæ‰ä½¿èƒ½PWMå ç©ºæ¯”è°ƒèŠ‚
 199   3                  {
 200   4                      // =================================================================
 201   4                      // pwm_channel_0                                               //
 202   4                      // =================================================================
 203   4                      if (adjust_pwm_channel_0_duty > cur_pwm_channel_0_duty)
 204   4                      {
 205   5                          cur_pwm_channel_0_duty++;
 206   5                      }
 207   4                      else if (adjust_pwm_channel_0_duty < cur_pwm_channel_0_duty)
 208   4                      {
 209   5                          cur_pwm_channel_0_duty--;
 210   5                      }
 211   4      
 212   4                      // =================================================================
 213   4                      // pwm_channel_1                                               //
 214   4                      // =================================================================
 215   4                      if (adjust_pwm_channel_1_duty > cur_pwm_channel_1_duty)
 216   4                      {
 217   5                          cur_pwm_channel_1_duty++;
 218   5                      }
 219   4                      else if (adjust_pwm_channel_1_duty < cur_pwm_channel_1_duty)
 220   4                      {
 221   5                          cur_pwm_channel_1_duty--;
C51 COMPILER V9.60.7.0   TIMER2                                                            01/26/2026 10:01:40 PAGE 5   

 222   5                      }
 223   4      
 224   4                      set_pwm_channel_0_duty(cur_pwm_channel_0_duty);
 225   4                      set_pwm_channel_1_duty(cur_pwm_channel_1_duty);
 226   4      
 227   4                      if (cur_pwm_channel_0_duty <= 0)
 228   4                      {
 229   5                          // å°äºŽæŸä¸ªå€¼ï¼Œç›´æŽ¥è¾“å‡º0%å ç©ºæ¯”ï¼Œå…³é—­PWMè¾“å‡ºï¼Œå¼•è„šé…ç½®ä¸ºè¾“å‡º
             -æ¨¡å¼
 230   5                          pwm_channel_0_disable();
 231   5                      }
 232   4                      else // å¦‚æžœå¤§äºŽ0
 233   4                      {
 234   5                          pwm_channel_0_enable();
 235   5                      }
 236   4      
 237   4                      if (cur_pwm_channel_1_duty <= 0)
 238   4                      {
 239   5                          // å°äºŽæŸä¸ªå€¼ï¼Œç›´æŽ¥è¾“å‡º0%å ç©ºæ¯”ï¼Œå…³é—­PWMè¾“å‡ºï¼Œå¼•è„šé…ç½®ä¸ºè¾“å‡º
             -æ¨¡å¼
 240   5                          pwm_channel_1_disable();
 241   5                      }
 242   4                      else // å¦‚æžœå¤§äºŽ0
 243   4                      {
 244   5                          pwm_channel_1_enable();
 245   5                      }
 246   4      
 247   4                  } // if (0 == flag_is_in_power_on) // ä¸å¤„äºŽå¼€æœºç¼“å¯åŠ¨ï¼Œæ‰ä½¿èƒ½PWMå ç©ºæ¯”è°ƒèŠ‚
 248   3      
 249   3      #if 0
                          // printf("c_duty %u\n", c_duty);
                          // printf(",c=%u\n", c_duty);
              #endif
 253   3              }
 254   2      #endif // è°ƒèŠ‚PWMå ç©ºæ¯”
 255   2          }
 256   1      
 257   1          // é€€å‡ºä¸­æ–­è®¾ç½®IPï¼Œä¸å¯åˆ é™¤
 258   1          __IRQnIPnPop(TMR2_IRQn);
 259   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    714    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =     15    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      2    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
