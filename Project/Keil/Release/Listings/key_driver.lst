C51 COMPILER V9.60.7.0   KEY_DRIVER                                                        02/26/2026 17:11:38 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE KEY_DRIVER
OBJECT MODULE PLACED IN .\Release\Objects\key_driver.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE ..\..\User\key_driver.c LARGE OPTIMIZE(9,SIZE) BROWSE INTVECTOR(0X000C) 
                    -INCDIR(..\..\Libraries\Include;..\..\User) INTERVAL(3) DEBUG OBJECTEXTEND PRINT(.\Release\Listings\key_driver.lst) OBJEC
                    -T(.\Release\Objects\key_driver.obj)

line level    source

   1          #include "key_driver.h"
   2            
   3          enum
   4          {
   5              KEY_SCAN_STATUS_NONE = 0,       // æ— ç‰¹æ®ŠçŠ¶æ€
   6              KEY_SCAN_STATUS_TO_NOTIFY,      // å‘é€æŒ‰é”®æ¶ˆæ¯
   7              KEY_SCAN_STATUS_TO_END_OF_SCAN, // æŒ‰é”®æ‰«æç»“æŸï¼Œè¿›è¡Œæ”¶å°¾å¤„ç†
   8          };
   9          
  10          static volatile u8 is_key_active; // æŒ‰é”®æ˜¯å¦æœ‰æ•ˆçš„è®¡æ•°å€¼
  11          
  12          //=======================================================//
  13          // æŒ‰é”®æ‰«æå‡½æ•°: æ‰«ææ‰€æœ‰æ³¨å†Œçš„æŒ‰é”®é©±åŠ¨
  14          //=======================================================//
  15          // xdata volatile struct key_driver_para *scan_para; // è¦è®©æŒ‡é’ˆæŒ‡å‘xdataåŒºåŸŸçš„å…¨å±€å˜é‡ï¼Œéœ€
             -è¦åŒæ ·å°†æŒ‡é’ˆå˜ä¸ºå…¨å±€å˜é‡
  16          volatile struct key_driver_para *scan_para; // è¦è®©æŒ‡é’ˆæŒ‡å‘xdataåŒºåŸŸçš„å…¨å±€å˜é‡ï¼Œéœ€è¦åŒæ ·
             -å°†æŒ‡é’ˆå˜ä¸ºå…¨å±€å˜é‡
  17          void key_driver_scan(void *_scan_para)
  18          // struct key_driver_para key_driver_scan(struct key_driver_para scan_para)
  19          {
  20   1          // volatile struct key_driver_para xdata *scan_para = (struct key_driver_para xdata *)_scan_para; // å
             -‡½æ•°å†…éƒ¨çš„æŒ‡é’ˆåªèƒ½æŒ‡å‘idataç©ºé—´ï¼Œä¸èƒ½æŒ‡å‘å…¨å±€å˜é‡çš„xdataç©ºé—´
  21   1          // volatile struct key_driver_para xdata *scan_para = (struct key_driver_para xdata *)0x642D; // ç³»ç»
             -Ÿä¼šä¸€ç›´å¤ä½
  22   1      
  23   1      #if 1
  24   1          u8 key_event = KEY_EVENT_NONE; // å­˜æ”¾å¾…å‘é€çš„æŒ‰é”®äº‹ä»¶
  25   1          u8 cur_key_value = NO_KEY;     // å­˜æ”¾å¾…å‘é€çš„æŒ‰é”®é”®å€¼
  26   1          u8 key_value = NO_KEY;
  27   1      
  28   1          // u8 key_scan_status = KEY_SCAN_STATUS_NONE; // çŠ¶æ€æœºï¼Œè´Ÿè´£æŽ§åˆ¶è¯¥å‡½æ•°å†…çš„è·³è½¬æ“ä½œ /
             -* æŽ§åˆ¶è·³è½¬è¿˜æœ‰é—®é¢˜ï¼Œè¿˜ä¸èƒ½ä½¿ç”¨ */
  29   1      
  30   1          scan_para = (struct key_driver_para *)_scan_para;
  31   1      
  32   1          // å¦‚æžœæ‰«ææ—¶é—´æœªåˆ°æ¥ï¼Œä¸æ‰§è¡ŒæŒ‰é”®æ‰«æ
  33   1          if (scan_para->cur_scan_times < scan_para->scan_times)
  34   1          {
  35   2              return;
  36   2          }
  37   1      
  38   1          scan_para->cur_scan_times = 0; // æ¸…ç©ºæ‰«ææ—¶é—´
  39   1      
  40   1          cur_key_value = scan_para->get_value(); // è°ƒç”¨ç”¨æˆ·è‡ªå®šä¹‰çš„èŽ·å–é”®å€¼å‡½æ•°
  41   1      
  42   1          // if (cur_key_value != NO_KEY)
  43   1          //     printf("key id %bu\n", cur_key_value); // æ‰“å°èŽ·å–åˆ°çš„é”®å€¼
  44   1      
  45   1          // åˆ¤æ–­æŒ‰é”®æ˜¯å¦æœ‰æ•ˆ
  46   1          if (cur_key_value != NO_KEY)
  47   1          {
  48   2              is_key_active = 35; // 35*10Ms
C51 COMPILER V9.60.7.0   KEY_DRIVER                                                        02/26/2026 17:11:38 PAGE 2   

  49   2          }
  50   1          else if (is_key_active)
  51   1          {
  52   2              is_key_active--;
  53   2          }
  54   1      
  55   1          //===== æŒ‰é”®æ¶ˆæŠ–å¤„ç†
  56   1          if (cur_key_value != scan_para->filter_value && scan_para->filter_time)
  57   1          {
  58   2              // å½“å‰æŒ‰é”®å€¼ä¸Žä¸Šä¸€æ¬¡æŒ‰é”®å€¼å¦‚æžœä¸ç›¸ç­‰, é‡æ–°æ¶ˆæŠ–å¤„ç†, æ³¨æ„filter_time != 0
             -;
  59   2              scan_para->filter_cnt = 0;               // æ¶ˆæŠ–æ¬¡æ•°æ¸…0, é‡æ–°å¼€å§‹æ¶ˆæŠ–
  60   2              scan_para->filter_value = cur_key_value; // è®°å½•ä¸Šä¸€æ¬¡çš„æŒ‰é”®å€¼
  61   2              return;                                  // ç¬¬ä¸€æ¬¡æ£€æµ‹, è¿”å›žä¸åšå¤„ç†
  62   2          }
  63   1      
  64   1          // å½“å‰æŒ‰é”®å€¼ä¸Žä¸Šä¸€æ¬¡æŒ‰é”®å€¼ç›¸ç­‰, filter_cntå¼€å§‹ç´¯åŠ ;
  65   1          if (scan_para->filter_cnt < scan_para->filter_time)
  66   1          {
  67   2              scan_para->filter_cnt++;
  68   2              return;
  69   2          }
  70   1      
  71   1          //===== æŒ‰é”®æ¶ˆæŠ–ç»“æŸ, å¼€å§‹åˆ¤æ–­æŒ‰é”®ç±»åž‹(å•å‡», åŒå‡», é•¿æŒ‰, å¤šå‡», HOLD, (é•¿æŒ‰/HOL
             -D)æŠ¬èµ·)
  72   1          if (cur_key_value != scan_para->last_key)
  73   1          {
  74   2              /*
  75   2                  å¦‚æžœå½“å‰çš„é”®å€¼ä¸ºç©ºï¼Œä¸Šä¸€æ¬¡çš„é”®å€¼åˆä¸Žå½“å‰çš„é”®å€¼ä¸ä¸€æ ·ï¼Œè¯´æ˜ŽæŒ‰é”®æ
             -¾å¼€
  76   2                  cur_key = NO_KEY; last_key = valid_key -> æŒ‰é”®è¢«æŠ¬èµ·
  77   2              */
  78   2              // printf("key event up\n");
  79   2      
  80   2              if (cur_key_value == NO_KEY)
  81   2              {
  82   3                  if (scan_para->press_cnt >= scan_para->long_time)
  83   3                  { // é•¿æŒ‰/HOLDçŠ¶æ€ä¹‹åŽè¢«æŒ‰é”®æŠ¬èµ·;
  84   4                      key_event = KEY_EVENT_UP;
  85   4                      key_value = scan_para->last_key;
  86   4                      goto _notify; // å‘é€æŠ¬èµ·æ¶ˆæ¯
  87   4                      // key_scan_status = KEY_SCAN_STATUS_TO_NOTIFY; // è·³è½¬åˆ°å‘é€æŒ‰é”®äº‹ä»¶çš„æ“ä½œ
  88   4                  }
  89   3      
  90   3                  // if (KEY_SCAN_STATUS_NONE == key_scan_status) // å¦‚æžœæ²¡æœ‰ç‰¹æ®Šæ“ä½œ
  91   3                  {
  92   4                      scan_para->click_delay_cnt = 1; // æŒ‰é”®ç­‰å¾…ä¸‹æ¬¡è¿žå‡»å»¶æ—¶å¼€å§‹
  93   4                  }
  94   3              }
  95   2              else
  96   2              {
  97   3                  /*
  98   3                      å¦‚æžœå½“å‰çš„é”®å€¼ä¸ä¸ºç©ºï¼Œä¸Šä¸€æ¬¡çš„é”®å€¼åˆä¸Žå½“å‰çš„é”®å€¼ä¸ä¸€æ ·ï¼Œè¯´æ˜Ž
             -æŒ‰é”®æŒ‰ä¸‹
  99   3                      cur_key = valid_key, last_key = NO_KEY -> æŒ‰é”®è¢«æŒ‰ä¸‹
 100   3                  */
 101   3                  scan_para->press_cnt = 1; // ç”¨äºŽåˆ¤æ–­longå’Œholdäº‹ä»¶çš„è®¡æ•°å™¨é‡æ–°å¼€å§‹è®¡æ—¶;
 102   3                  if (cur_key_value != scan_para->notify_value)
 103   3                  { // ç¬¬ä¸€æ¬¡å•å‡»/è¿žå‡»æ—¶æŒ‰ä¸‹çš„æ˜¯ä¸åŒæŒ‰é”®, å•å‡»æ¬¡æ•°é‡æ–°å¼€å§‹è®¡æ•°
 104   4                      scan_para->click_cnt = 1;
 105   4                      scan_para->notify_value = cur_key_value;
 106   4                  }
C51 COMPILER V9.60.7.0   KEY_DRIVER                                                        02/26/2026 17:11:38 PAGE 3   

 107   3                  else
 108   3                  {
 109   4                      scan_para->click_cnt++; // å•å‡»æ¬¡æ•°ç´¯åŠ 
 110   4                  }
 111   3              }
 112   2      
 113   2              goto _scan_end; // è¿”å›ž, ç­‰å¾…å»¶æ—¶æ—¶é—´åˆ°
 114   2              // if (KEY_SCAN_STATUS_NONE == key_scan_status)
 115   2              // {
 116   2              //     key_scan_status = KEY_SCAN_STATUS_TO_END_OF_SCAN; // è¿”å›ž, ç­‰å¾…å»¶æ—¶æ—¶é—´åˆ°
 117   2              // }
 118   2          }
 119   1          else
 120   1          {
 121   2              /*
 122   2                  å¦‚æžœå½“å‰èŽ·å–çš„é”®å€¼ä¸Žä¸Šæ¬¡èŽ·å–çš„é”®å€¼ä¸€æ ·ï¼Œè¯´æ˜ŽæŒ‰é”®åœ¨é•¿æŒ‰æˆ–æ˜¯æŒ‰é”®æ
             -œªæŒ‰ä¸‹
 123   2                  cur_key = last_key -> æ²¡æœ‰æŒ‰é”®æŒ‰ä¸‹/æŒ‰é”®é•¿æŒ‰(HOLD)
 124   2              */
 125   2              if (cur_key_value == NO_KEY)
 126   2              {
 127   3                  // last_key = NO_KEY; cur_key = NO_KEY -> æ²¡æœ‰æŒ‰é”®æŒ‰ä¸‹
 128   3                  if (scan_para->click_cnt > 0)
 129   3                  { // æœ‰æŒ‰é”®éœ€è¦æ¶ˆæ¯éœ€è¦å¤„ç†
 130   4      
 131   4                      // å¦‚æžœåªå“åº”å•å‡»äº‹ä»¶ï¼Œå¯ä»¥åœ¨è¿™é‡Œæ·»åŠ /ä¿®æ”¹åŠŸèƒ½
 132   4      
 133   4                      if (scan_para->click_delay_cnt > scan_para->click_delay_time)
 134   4                      { // æŒ‰é”®è¢«æŠ¬èµ·åŽå»¶æ—¶åˆ°
 135   5                          // TODO: åœ¨æ­¤å¯ä»¥æ·»åŠ ä»»æ„å¤šå‡»äº‹ä»¶
 136   5                          // if (scan_para->click_cnt >= 5)
 137   5                          // {
 138   5                          //     key_event = KEY_EVENT_FIRTH_CLICK; // äº”å‡»
 139   5                          // }
 140   5                          // else if (scan_para->click_cnt >= 4)
 141   5                          // {
 142   5                          //     key_event = KEY_EVENT_FOURTH_CLICK; // 4å‡»
 143   5                          // }
 144   5                          // else if (scan_para->click_cnt >= 3)
 145   5                          // {
 146   5                          //     key_event = KEY_EVENT_TRIPLE_CLICK; // ä¸‰å‡»
 147   5                          // }
 148   5                          // else if (scan_para->click_cnt >= 2)
 149   5                          // if (scan_para->click_cnt >= 2)
 150   5                          // {
 151   5                          //     key_event = KEY_EVENT_DOUBLE_CLICK; // åŒå‡»
 152   5                          // }
 153   5                          // else
 154   5                          {
 155   6                              key_event = KEY_EVENT_CLICK; // å•å‡»
 156   6                              // printf("click \n");
 157   6                          }
 158   5                          key_value = scan_para->notify_value;
 159   5      
 160   5                          goto _notify;
 161   5                          // key_scan_status = KEY_SCAN_STATUS_TO_NOTIFY;
 162   5                      }
 163   4                      else
 164   4                      { // æŒ‰é”®æŠ¬èµ·åŽç­‰å¾…ä¸‹æ¬¡å»¶æ—¶æ—¶é—´æœªåˆ°
 165   5                          scan_para->click_delay_cnt++;
 166   5                          goto _scan_end; // æŒ‰é”®æŠ¬èµ·åŽå»¶æ—¶æ—¶é—´æœªåˆ°, è¿”å›ž
 167   5                          // key_scan_status = KEY_SCAN_STATUS_TO_END_OF_SCAN;
C51 COMPILER V9.60.7.0   KEY_DRIVER                                                        02/26/2026 17:11:38 PAGE 4   

 168   5                      }
 169   4                  }
 170   3                  else
 171   3                  {
 172   4                      goto _scan_end; // æ²¡æœ‰æŒ‰é”®éœ€è¦å¤„ç†
 173   4                      // key_scan_status = KEY_SCAN_STATUS_TO_END_OF_SCAN;
 174   4                  }
 175   3              }
 176   2              else
 177   2              {
 178   3                  // last_key = valid_key; cur_key = valid_key, press_cntç´¯åŠ ç”¨äºŽåˆ¤æ–­longå’Œhold
 179   3                  if (scan_para->press_cnt < 255)
 180   3                  {
 181   4                      scan_para->press_cnt++;
 182   4                  }
 183   3      
 184   3                  // printf("long time %bu\n", scan_para->long_time);
 185   3                  // printf("press cnt %bu\n", scan_para->press_cnt);
 186   3                  if (scan_para->press_cnt == scan_para->long_time)
 187   3                  {
 188   4                      key_event = KEY_EVENT_LONG;
 189   4      
 190   4                      // printf("long time %bu\n", scan_para->long_time);
 191   4      
 192   4                      // printf("key event long\n");
 193   4                  }
 194   3                  else if (scan_para->press_cnt == scan_para->hold_time)
 195   3                  {
 196   4                      key_event = KEY_EVENT_HOLD;
 197   4                      scan_para->press_cnt = scan_para->long_time; // ä¸‹ä¸€æ¬¡scan_para->press_cnt++,è¿˜æ˜¯ä¼šè
             -¿›å…¥åˆ°è¿™é‡Œ
 198   4                      // printf("key event hold\n");
 199   4                  }
 200   3                  else
 201   3                  {
 202   4                      goto _scan_end; // press_cntæ²¡åˆ°é•¿æŒ‰å’ŒHOLDæ¬¡æ•°, è¿”å›ž
 203   4                      // key_scan_status = KEY_SCAN_STATUS_TO_END_OF_SCAN;
 204   4                  }
 205   3      
 206   3                  // press_cntæ²¡åˆ°é•¿æŒ‰å’ŒHOLDæ¬¡æ•°, å‘æ¶ˆæ¯
 207   3                  key_value = cur_key_value;
 208   3                  goto _notify;
 209   3                  // key_scan_status = KEY_SCAN_STATUS_TO_NOTIFY;
 210   3              }
 211   2          }
 212   1      
 213   1      _notify:
 214   1      
 215   1          // if (KEY_SCAN_STATUS_TO_END_OF_SCAN != key_scan_status)
 216   1          {
 217   2              // if (KEY_TYPE_AD == scan_para->key_type) // å¦‚æžœæ˜¯adæŒ‰é”®
 218   2              {
 219   3                  scan_para->click_cnt = 0;         // æŒ‰ä¸‹æ¬¡æ•°æ¸…0
 220   3                  scan_para->notify_value = NO_KEY; // åœ¨å»¶æ—¶çš„å¾…å‘é€æŒ‰é”®å€¼æ¸…é›¶
 221   3      
 222   3                  scan_para->latest_key_val = key_value;   // å­˜æ”¾å¾—åˆ°çš„æŒ‰é”®é”®å€¼
 223   3                  scan_para->latest_key_event = key_event; // å­˜æ”¾å¾—åˆ°çš„æŒ‰é”®äº‹ä»¶
 224   3      
 225   3                  // printf("notify\n");
 226   3              }
 227   2              // else if (KEY_TYPE_TOUCH == scan_para->key_type) // å¦‚æžœæ˜¯è§¦æ‘¸æŒ‰é”®
 228   2              // {
C51 COMPILER V9.60.7.0   KEY_DRIVER                                                        02/26/2026 17:11:38 PAGE 5   

 229   2              //     scan_para->click_cnt = 0;         // æŒ‰ä¸‹æ¬¡æ•°æ¸…0
 230   2              //     scan_para->notify_value = NO_KEY; // åœ¨å»¶æ—¶çš„å¾…å‘é€æŒ‰é”®å€¼æ¸…é›¶
 231   2      
 232   2              //     scan_para->latest_key_val = key_value;   // å­˜æ”¾å¾—åˆ°çš„æŒ‰é”®é”®å€¼
 233   2              //     scan_para->latest_key_event = key_event; // å­˜æ”¾å¾—åˆ°çš„æŒ‰é”®äº‹ä»¶
 234   2              // }
 235   2          }
 236   1      
 237   1      _scan_end:
 238   1          scan_para->last_key = cur_key_value;
 239   1          return;
 240   1      #endif
 241   1      }
 242           


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    436    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =      4       2
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
