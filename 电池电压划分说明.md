# 电池电压划分方案说明

## 1. 电池电压范围
- **工作电压范围**: 2.5V - 4.2V
- **满电电压**: 4.2V
- **耗尽电压**: 2.5V
- **电压跨度**: 1.7V (1700mV)

## 2. 电量百分比划分方案

### 推荐划分方式（考虑锂电池特性）：

| 电量百分比 | 电压值(mV) | 电压区间 | 说明 |
|-----------|------------|----------|------|
| 100% | 4200 | 4.2V | 满电状态 |
| 75% | 3850 | 3.85V | 高电量区域 |
| 50% | 3600 | 3.6V | 中等电量区域 |
| 25% | 3200 | 3.2V | 低电量警告区域 |
| 0% | 2500 | 2.5V | 电池耗尽 |

### 划分原理：
1. **非线性补偿**: 锂电池放电曲线不是完全线性的，在不同电压区间放电速度不同
2. **安全考虑**: 设置合理的低电量警告点，避免过度放电
3. **用户体验**: 在常用电量区间提供更精确的指示

## 3. ADC转换关系

### 硬件配置：
- **参考电压**: 内部2.0V参考电压
- **分压比**: VDD经过1/5分压后输入ADC
- **ADC精度**: 12位 (0-4095)

### 计算公式：
```
实际电池电压(mV) = ADC值 × (2000mV/4096) × 5
```

### 关键ADC值对应表：

| 电压(mV) | ADC值 | 百分比 |
|----------|-------|--------|
| 4200 | 2048 | 100% |
| 3850 | 1876 | 75% |
| 3600 | 1755 | 50% |
| 3200 | 1560 | 25% |
| 2500 | 1221 | 0% |

## 4. 软件实现要点

### 线性插值算法：
```c
// 分段线性插值计算百分比
if (voltage >= 3850) {
    // 75%-100% 区间
    percentage = 75 + (voltage - 3850) × 25 / (4200 - 3850)
} else if (voltage >= 3600) {
    // 50%-75% 区间
    percentage = 50 + (voltage - 3600) × 25 / (3850 - 3600)
} // ... 其他区间类似处理
```

### 滞回比较防抖动：
```c
// 避免电量显示在边界值附近频繁跳变
#define HYSTERESIS_MV 50  // 50mV滞回窗口

if (new_voltage > old_voltage + HYSTERESIS_MV || 
    new_voltage < old_voltage - HYSTERESIS_MV) {
    // 更新电量显示
}
```

## 5. 不同划分方案对比

### 方案A：均匀线性划分
```
100%: 4200mV
75%:  3775mV  (4200 - 425)
50%:  3350mV  (4200 - 850)
25%:  2925mV  (4200 - 1275)
0%:   2500mV
```

### 方案B：推荐的非线性划分（本方案）
```
100%: 4200mV
75%:  3850mV  (更保守的高电量判断)
50%:  3600mV  (常用工作区间)
25%:  3200mV  (提前警告低电量)
0%:   2500mV
```

### 方案C：激进划分
```
100%: 4200mV
75%:  3950mV
50%:  3500mV
25%:  3000mV
0%:   2500mV
```

## 6. 使用建议

### 1. 参数调整
根据实际使用的电池型号特性，可以微调各百分比对应的电压值：
- 新电池：可适当提高各电压阈值
- 老化电池：可适当降低各电压阈值

### 2. 显示策略
- **100%-75%**: 正常显示绿色
- **74%-50%**: 正常显示蓝色
- **49%-25%**: 警告显示黄色，提醒充电
- **24%-0%**: 危险显示红色，强制节能模式

### 3. 低电量处理
```c
// 示例低电量处理逻辑
if (battery_percentage <= 25) {
    // 降低LED亮度
    // 缩短工作时间
    // 提示用户充电
}

if (battery_percentage <= 10) {
    // 进入省电模式
    // 限制最大功率
    // 频繁提醒充电
}
```

## 7. 注意事项

1. **温度影响**: 低温环境下电池电压会偏低，可能影响电量判断准确性
2. **负载影响**: 大电流放电时电压会瞬时下降，建议采样时避开大功率输出时段
3. **电池老化**: 随着使用时间增长，同样电压对应的剩余容量会减少
4. **校准需求**: 建议在首次使用时进行简单的电压校准

## 8. 测试验证方法

### 静态测试：
1. 使用可调电源模拟不同电池电压
2. 验证各电压点对应的百分比显示是否准确

### 动态测试：
1. 实际充放电循环测试
2. 观察电量显示与实际使用时间的匹配度
3. 验证低电量警告的及时性

这套划分方案综合考虑了锂电池的物理特性、用户体验需求和系统安全性，可以根据具体应用场景进行适当的调整优化。