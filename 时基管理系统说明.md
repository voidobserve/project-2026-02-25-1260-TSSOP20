# 时基管理系统使用说明

## 概述

本系统提供了一个灵活的时基管理机制，可以为多个测试函数提供独立的时间基准控制。

## 系统特点

1. **独立时基控制**: 每个测试函数可以设置不同的执行周期
2. **动态配置**: 支持运行时启用/禁用时基
3. **资源节省**: 统一的计数器管理，减少系统开销
4. **易于扩展**: 新增测试函数只需添加对应的时基ID

## 使用步骤

### 1. 定义时基ID

在 `user_test.h` 中的 `timebase_id_t` 枚举中添加新的时基ID：

```c
typedef enum {
    TIMEBASE_ADC_SCAN = 0,      // ADC扫描测试时基
    TIMEBASE_LED_TEST,          // LED测试时基
    TIMEBASE_UART_TEST,         // UART测试时基
    TIMEBASE_PWM_TEST,          // PWM测试时基
    TIMEBASE_YOUR_TEST,         // 你的新测试时基
    TIMEBASE_MAX                // 最大时基数量
} timebase_id_t;
```

### 2. 初始化时基系统

在主程序初始化时调用：

```c
void main(void)
{
    // 系统初始化
    system_init();
    
    // 初始化时基管理系统
    timebase_init();
    
    // 设置各个测试函数的时基
    timebaseEnable(TIMEBASE_ADC_SCAN, 1000);  // 1秒执行一次
    timebaseEnable(TIMEBASE_LED_TEST, 500);   // 500ms执行一次
    
    while(1)
    {
        // 主循环
        main_loop();
    }
}
```

### 3. 在定时器中断中更新时基

建议在1ms定时器中断中调用时基更新：

```c
void timer0_isr(void) interrupt 1
{
    // 定时器处理...
    
    // 更新时基计数器
    timebaseUpdate();
}
```

### 4. 在测试函数中使用时基

修改测试函数使用时基触发：

```c
void user_test_your_function(void)
{
    // 检查时基是否触发
    if (isTimebaseTriggered(TIMEBASE_YOUR_TEST))
    {
        // 清除触发标志
        clearTimebaseFlag(TIMEBASE_YOUR_TEST);
        
        // 执行测试代码
        // your_test_code_here();
    }
}
```

### 5. 在主循环中调用测试函数

```c
void main_loop(void)
{
    // 执行各个测试函数
    user_test_adc_scan();
    user_test_led();
    user_test_your_function();
    
    // 其他主循环任务...
}
```

## API接口说明

### 核心函数

- `void timebaseInit(void)` - 初始化时基系统
- `void timebaseUpdate(void)` - 更新时基计数器（应在定时器中断中调用）
- `void timebaseEnable(timebase_id_t id, u16 interval_ms)` - 启用指定时基
- `void timebaseDisable(timebase_id_t id)` - 禁用指定时基
- `u8 isTimebaseTriggered(timebase_id_t id)` - 检查时基是否触发
- `void clearTimebaseFlag(timebase_id_t id)` - 清除时基触发标志

### 配置示例

```c
// 不同的测试频率配置
timebaseEnable(TIMEBASE_ADC_SCAN, 1000);    // 每1秒
timebaseEnable(TIMEBASE_LED_TEST, 500);     // 每500ms
timebaseEnable(TIMEBASE_UART_TEST, 100);    // 每100ms
timebaseEnable(TIMEBASE_PWM_TEST, 10);      // 每10ms

// 动态调整
timebaseDisable(TIMEBASE_PWM_TEST);         // 临时禁用
timebaseEnable(TIMEBASE_ADC_SCAN, 5000);    // 降低频率到5秒
```

## 注意事项

1. **时基更新频率**: `timebaseUpdate()` 必须定期调用，建议在1ms定时器中断中执行
2. **及时清除标志**: 使用完触发标志后要及时调用 `clearTimebaseFlag()`
3. **内存占用**: 每个时基占用8字节内存（4个u16字段）
4. **最大时基数量**: 由 `TIMEBASE_MAX` 定义，可根据需要调整

## 扩展示例

添加新的测试函数：

```c
// 1. 在枚举中添加ID
// TIMEBASE_NEW_TEST,

// 2. 实现测试函数
void user_test_new_function(void)
{
    if (isTimebaseTriggered(TIMEBASE_NEW_TEST))
    {
        clearTimebaseFlag(TIMEBASE_NEW_TEST);
        // 你的测试代码
    }
}

// 3. 在初始化时配置时基
timebaseEnable(TIMEBASE_NEW_TEST, 200);  // 200ms执行一次

// 4. 在主循环中调用
user_test_new_function();
```

这个时基管理系统提供了灵活且高效的多函数时间控制方案。